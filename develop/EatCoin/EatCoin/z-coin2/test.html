<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<title></title>
	<style type="text/css">
		* {
			padding: 0;
			margin: 0;
		}

		body {
			text-align: center;
		}

		#canvas {
			margin: 0 auto;
		}
	</style>

	<script language="JavaScript">

		// 金币
		var coinImg = new Image();
		coinImg.src = "coin.png";
		coinImg.value = 5;
		coinImg.speed = 5;
		//炸弹
		var bombImg = new Image();
		bombImg.src = "bomb.png";
		bombImg.value = 10;
		bombImg.speed = 10;
		//红包
		var redpaperImg = new Image();
		redpaperImg.src = "redpaper.png";
		redpaperImg.value = 20;
		redpaperImg.speed = 20;
		//孔雀
		var phoenixImg = new Image();
		phoenixImg.src = "phoenix.png";
		//背景
		var bg = new Image();
		bg.src = "bg.png";

		// 金币类;
		function Money(x, y, speed, img) {
			this.speed = speed;
			this.x = x;
			this.y = y;
			this.width = img.width;
			this.height = img.height;
			this.img = img;
			this.value = img.value;
		}
		Money.prototype = {
			draw: function (ctx) {
				ctx.drawImage(this.img, this.x, this.y);
			},
			move: function () {
				this.y += this.speed;
			}
		}
		// 孔雀
		function Phoenix(x, y, img) {
			this.grade = 0;
			this.life = 5;
			this.x = x;
			this.y = y;
			this.img = img;
			this.width = img.width;
			this.height = img.height;
		}
		Phoenix.prototype = {
			draw: function (ctx) {
				ctx.drawImage(this.img, this.x, this.y);
			},
			touch: function (other) {
				if (this.x + this.width > other.x && this.x < other.x + other.width &&
					this.y + this.height > other.y && this.y < other.y + other.height) {
					this.grade += other.value;
					return true;
				}
				return false;
			}
		}
		var App = {
			// 对象
			elements: [],
			backImg: bg,
			imgs: [coinImg, bombImg, redpaperImg],
			phoenix: null,
			// 画布
			canvas: null,
			// 绘制工具
			context: null,
			// 定时器
			timer: null,
			// 速度（更新间隔speed * 10）
			speed: 0,
			pause: false,
			// 绘制对象
			draw: function () {
				// 清屏
				this.context.clearRect(0, 0, this.canvas.width, canvas.height);
				// 绘制背景
				this.context.drawImage(this.backImg, 0, 0);
				// 绘制孔雀
				this.phoenix.draw(this.context);
				// 绘制金币
				for (var i = 0; i < this.elements.length; i++) {
					var o = this.elements[i];
					// 清理屏幕外的对象
					if (o.x > this.canvas.width || o.x < 0 || o.y > this.canvas.height || o.y < 0) {
						this.elements.splice(i, 1);
						//this.hero.life--;
					} else if (this.phoenix.touch(o)) {
						this.elements.splice(i, 1);
					} else {
						o.draw(this.context);
					}
				}
			},
			// 循环处理
			loop: function () {
				var me = App;
				if (me.pause) {
					return;
				}
				for (var i = 0; i < me.elements.length; i++) {
					me.elements[i].move();
				}
				var chance = Math.random() * 1000;
				// 1/10的对象添加概率
				if (chance < 100) {
					var img = me.imgs[parseInt(chance % me.imgs.length)];
					var x = Math.random() * (me.canvas.width - me.imgs[parseInt(chance % me.imgs.length)].width);
					var y = 0;
					var speed = img.speed;
					var money = new Money(x, y, speed, img);
					me.addElement(money);
				}
				me.draw();
				if (me.phoenix.life == 0) {
					me.gameOver();
				}
			},
			// 开始游戏
			gameStart: function (id, speed) {
				var me = this;
				me.canvas = document.getElementById(id);
				me.context = me.canvas.getContext("2d");
				me.speed = speed;
				me.phoenix = new Phoenix((me.canvas.width - phoenixImg.width) / 2, me.canvas.height - phoenixImg.height, phoenixImg);
				if (this.timer != null) me.gameOver();
				me.canvas.onmousemove = function (e) {
					e = window.event || e;
					var x = e.clientX - me.canvas.offsetLeft - me.phoenix.width / 2;

					if (x > 0 && x < me.canvas.width - me.phoenix.width) {
						me.phoenix.x = x;
					}
				}
				me.timer = setInterval(me.loop, me.speed * 10);
			},
			// 暂停游戏
			gamePause: function () {
				this.pause = true;
				this.context.textAlign = "center";
				this.context.fillStyle = "#f00";
				this.context.font = 'bold 50px Arial';
				this.context.fillText("Pause!", this.canvas.width / 2, this.canvas.height / 2);
				this.context.font = 'bold 20px Arial';
				this.context.fillText("Press space key to continue...", this.canvas.width / 2, this.canvas.height / 2 + 40);
			},
			// 结束游戏
			gameOver: function () {
				clearInterval(this.timer);
				this.elements = [];
				this.pause = false;
				this.timer = null;
				this.context.textAlign = "center";
				this.context.fillStyle = "#f00";
				this.context.font = 'bold 40px Arial';
				this.context.fillText("Game Over!", this.canvas.width / 2, this.canvas.height / 2);
			},
			// 添加对象
			addElement: function (o) {
				this.elements.push(o);
			}
		}

		window.onload = function () {
			var can = $("canvas");
			var ctx = $("canvas").getContext("2d");
			ctx.drawImage(bg, 0, 0);
			ctx.drawImage(phoenixImg, (can.width - phoenixImg.width) / 2, can.height - phoenixImg.height);
			ctx.textAlign = "center";
			ctx.fillStyle = "#f00";
			ctx.font = 'bold 20px Arial';
			ctx.fillText("Press space key to start...", can.width / 2, can.height / 2);
			document.onkeyup = function (e) {
				if (e.keyCode != 32) {
					return;
				}
				if (App.timer == null) {
					App.gameStart("canvas", 6);
				} else if (App.pause) {
					App.pause = false;
				} else {
					App.gamePause("canvas", 6);
				}
			}
		}
		function $(id) {
			return document.getElementById(id);
		}

	</script>
</head>
<body>
	<canvas width=1137 height=640 id="canvas" style="border:1px solid #ccc;background：url('bg.jpg')">
	</canvas>
</body>
</html>
